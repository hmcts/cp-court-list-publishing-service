spring:
  application:
    name: cp-court-list-publishing-service

  # Disable SpringDoc auto-configuration
  autoconfigure:
    exclude: org.springdoc.core.configuration.SpringDocKotlinConfiguration
  config:
    import: "optional:configtree:/mnt/secrets/rpe/"
  threads:
    virtual:
      enabled: ${VIRTUAL_THREADS:false}
  datasource:
    # Override these via env in each environment
    url: ${CP_CLP_DATASOURCE_URL:jdbc:postgresql://localhost:55432/courtlistpublishing}
    username: ${CP_CLP_DATASOURCE_USERNAME:courtlistpublishing}
    password: ${CP_CLP_DATASOURCE_PASSWORD:courtlistpublishing}
    driver-class-name: ${CP_CLP_DATASOURCE_DRIVER_CLASS_NAME:org.postgresql.Driver}
    hikari:
      pool-name: cp-hikari
      maximum-pool-size: ${CP_CLP_DB_POOL_SIZE:20}
      minimum-idle: ${CP_CLP_DB_MIN_IDLE:5}
      connection-timeout: 30000        # ms
      idle-timeout: 600000             # ms
      max-lifetime: 1800000            # ms
      keepalive-time: 300000           # ms
      validation-timeout: 5000         # ms
      auto-commit: false               # transactions must be committed manually — either by: Spring’s @Transactional annotation, or Explicit Connection.commit() calls in your code.

  jpa:
    open-in-view: false
    hibernate:
      ddl-auto: update               # schema managed by Flyway it is updating db
    properties:
      hibernate.jdbc.time_zone: UTC
      hibernate.connection.provider_disables_autocommit: true
      hibernate.jdbc.batch_size: 50
      hibernate.order_inserts: true
      hibernate.order_updates: true

  sql:
    init:
      mode: never

flyway:
  enabled: true
  locations: classpath:db/migration
  baseline-on-migrate: ${FLYWAY_BASELINE_ON_MIGRATE:false}

server:
  port: ${SERVER_PORT:8082}
  servlet:
    context-path: /courtlistpublishing-service
  shutdown: graceful
  http2:
    enabled: true
  forward-headers-strategy: framework   # honor X-Forwarded-* behind proxies
  compression:
    enabled: true
    min-response-size: 2KB
    mime-types: "application/json"

management:
  server:
    # Keep actuator on same port by default; override if you want a separate port
    port: ${MANAGEMENT_SERVER_PORT:${SERVER_PORT:8082}}
  endpoints:
    web:
      base-path: /actuator
      exposure:
        include: health, info, prometheus
  endpoint:
    health:
      probes:
        enabled: true                  # liveness/readiness groups
  metrics:
    tags:
      service: cp-court-list-publishing-service
      cluster: ${CLUSTER_NAME:local}
      region: ${REGION:local}
  tracing:
    enabled: ${OTEL_METRICS_ENABLED:false}
    sampling:
      probability: ${TRACING_SAMPLER_PROBABILITY:1.0}
  otlp:
    tracing:
      enabled: ${OTEL_METRICS_ENABLED:false}
      endpoint: ${OTEL_TRACES_URL:http://localhost:4318/traces}
      export:
        enabled: ${OTEL_METRICS_ENABLED:false}
    metrics:
      export:
        enabled: ${OTEL_METRICS_ENABLED:false}
        url: ${OTEL_METRICS_URL:http://localhost:4318/metrics}

# Temporarily commented out due to SpringDoc compatibility issues with Spring Boot 4.0.0-M3
# springdoc:
#   packagesToScan: uk.gov.hmcts.cp.controllers
#   writer-with-order-by-keys: true

azure:
  application-insights:
    instrumentation-key: ${rpe.AppInsightsInstrumentationKey:00000000-0000-0000-0000-000000000000}
  storage:
    enabled: ${AZURE_STORAGE_ENABLED:false}
    container-name: schedulelistinginput
    account-name: ${AZURE_STORAGE_ACCOUNT_NAME}
  client-id: ${AZURE_CLIENT_ID}
  tenant-id: ${AZURE_TENANT_ID}

jwt:
  # Expose upwards to allow env var override: export JWT_SECRET_KEY=... (base64, 256-bit min)
  secretKey: ${JWT_SECRET_KEY:it-must-be-a-string-secret-at-least-256-bits-long}
  filter:
    enabled: false

logging:
  level:
    root: INFO
  # Use your JSON config (async) — make sure this file exists
  config: classpath:logback.xml